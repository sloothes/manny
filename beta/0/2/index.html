<!DOCTYPE html>
<html lang="en">
	<head>

		<title>Battle royale game (beta-0.1)</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/joystick.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">

		<script src="/js/watch.js"></script>
		<script src="/js/jquery.min.js"></script> 
		<script src="/js/system.min.js"></script>
		<script src="/js/signals.min.js"></script>
		<script src="/js/inflate.min.js"></script>
		<script src="/js/zangodb.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
		<script src="/js/hold-event.min.js"></script>

		<style>

			body {
				font-family: sans-serif;
				font-size: 13px;
				background-color: #000;
				margin: 0px;
				overflow: hidden;
			}

			#loading-bar {
				width:100%;
				height:100%;
				top:0; left:0;
				position:fixed;
				display:flex;
				align-items:center;
				justify-content:center;
			}

			.middle > * {
				top:0; 
				left:0;
				right:0;
				bottom:0;
				margin:auto;"
				position:absolute;
			}

			#joystick1 {
				right: calc(40px + 370px);
			}
			
			#jumpButton {
				right: calc(105px + 370px);
			}

			.btn-action {
				padding:0;
				float:left;
				width:55px;
				height:55px;
				border:1px solid;
				border-radius:4px;
				margin-right:4px;
				margin-bottom:4px;
				display:inline-block;
			}
			
			.btn-action + .btn-action {
				margin-right:4px;
			}

		</style>
	</head>

	<body ontouchstart="">

		<script src="/manny/js/three.js"></script>
		<script src="/manny/js/TabUI.js"></script>
		<script src="/manny/js/MeshWalk.js"></script>
		<script src="/manny/js/UVsDebug.js"></script>
		<script src="/manny/js/FBXLoader.js"></script>
		<script src="/manny/js/VirtualInput.js"></script>
		<script src="/manny/js/EditorControls.js"></script>
		<script src="/manny/js/camera-controls.js"></script>
		<script src="/manny/js/SubdivisionModifier.js"></script>
		<script src="/manny/js/three-pathfinding.umd.js"></script>
		<script src="/threejs/r96/examples/js/loaders/GLTFLoader.js"></script>
		<script src="/threejs/r96/examples/js/exporters/GLTFExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/STLExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/OBJExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/ColladaExporter.js"></script>

		<script>

			debugMode = true; // important!
			MW.install( THREE ); // important!

		//	CameraControls.install( {THREE:THREE} ); // demo!
		//	THREE.Pathfinding = threePathfinding.Pathfinding;
		//	THREE.PathfindingHelper = threePathfinding.PathfindingHelper;
		//	IMPORTANT NOTE: at "/manny/js/three.js" (r96),
		//	we comment line 43269: "// if ( object.visible === false ) return;"

			Number.prototype.format = function (){
				return this.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
			};

			function round(number, precision) {
				var shift = function (number, precision, reverseShift) {
					if (reverseShift) {
						precision = -precision;
					}  
					numArray = ("" + number).split("e");
					return +(numArray[0] + "e" + (numArray[1] ? (+numArray[1] + precision) : precision));
				};
				return shift(Math.round(shift(number, precision, false)), precision, true);
			}

		</script>

		<script>

			(function(){

			//	const w = 370; // important!

			//	Scene.
				scene = new THREE.Scene();

			//	Camera.
				(function(){

					var aspect = (window.innerWidth - 370) / window.innerHeight;
					camera = new THREE.PerspectiveCamera( 50, aspect, 1, 100000 );
					camera.position.set(0, 10, 50);

				})();

			//  Camera Light.
				(function(){

					cameraLight = new THREE.DirectionalLight( 0xdfebff, 0.75 );
					cameraLight.position.set( 0, 500, 300 );
					cameraLight.castShadow = true;
					cameraLight.shadow.mapSize.width  = Math.pow(2, 10); // 2048;
					cameraLight.shadow.mapSize.height = Math.pow(2, 10); // 2048;

					var d = 30;
					cameraLight.shadow.camera.left = - d;
					cameraLight.shadow.camera.right = d;
					cameraLight.shadow.camera.top = d;
					cameraLight.shadow.camera.bottom = - d;
					cameraLight.shadow.camera.far = 10000;

					shadowHelper = new THREE.CameraHelper(cameraLight.shadow.camera);
					shadowHelper.visible = false;

					scene.add( cameraLight, shadowHelper  );

					(function update(){
						requestAnimationFrame( update );
						cameraLight.position.copy( camera.position );
					})();

				})();

			//  Renderer.
				(function(){

					renderer = new THREE.WebGLRenderer({
						antialias: true,
						preserveDrawingBuffer: true,
					});

					renderer.gammaInput = true;
					renderer.gammaOutput = true;
					renderer.shadowMap.enabled = true;
					renderer.setClearColor( 0x000000 );
					renderer.setPixelRatio( window.devicePixelRatio );
					renderer.setSize( (window.innerWidth - 370), window.innerHeight );
					document.body.appendChild( renderer.domElement );

					window.addEventListener("resize", function onWindowResize() {
						renderer.setSize( (window.innerWidth - 370), window.innerHeight );
					});

					window.addEventListener("resize", function onWindowResize() {
						camera.aspect = renderer.domElement.clientWidth / renderer.domElement.clientHeight;
						camera.updateProjectionMatrix();
					});

					mouse = new THREE.Vector2();

					renderer.domElement.addEventListener("mousemove", function(e) {
						mouse.x = ( e.clientX / this.clientWidth ) * 2 - 1;
						mouse.y = - ( e.clientY / this.clientHeight ) * 2 + 1;
					});

					(function render(){
						requestAnimationFrame( render );
						renderer.render( scene, camera );
					})();

				})();

			//	Editor Controls.
				setTimeout(function(){
					controls = new THREE.EditorControls(camera, renderer.domElement);
					controls.center.set(0, 10, 0);
					camera.lookAt(controls.center); // important!
				});

			})();

		//	World - Octree.

			(function(){

				world = new MW.World();

				var x = 1500, y = 1500, z = 1500;
				var min = new THREE.Vector3( -x, -y, -z );
				var max = new THREE.Vector3(  x,  y,  z );
				var partition = 7; // nodes: Math.pow( 8, partition )

				octree = new MW.Octree( min, max, partition );
				world.add( octree );

				var clock = new THREE.Clock();

				(function update(){
					requestAnimationFrame( update );
					var delta = clock.getDelta();
					var elapsed = clock.getElapsedTime();
					world.step( Math.min( delta, 0.02 ) );
					scene.updateMatrixWorld(); // important!
				})();

			})();

			(function(){

			//	ground.
				ground = new THREE.Mesh(
					new THREE.PlaneGeometry( 3000, 3000, 1, 1 ).rotateX(-Math.PI/2),
					new THREE.MeshLambertMaterial({ 
						opacity:1, 
						color:0x829ec4,
					})
				);

			//	We need only the geometry of the ground
			//	so there is not need to add to the scene.
			//	ground.rotation.x = -Math.PI / 2;
				octree.importThreeMesh( ground ); // important!
			//	scene.add( ground ); // optional!

			//	Ground Helper.
				groundHelper = new THREE.GridHelper( 3000, 300, 0x444444, 0x444444 );
				scene.add( groundHelper );

			//	Ground Raycaster.
				setTimeout(function(){
					var raycaster = new THREE.Raycaster();
					var intersecthelper = new THREE.Mesh(
						new THREE.CircleBufferGeometry( 2, 32 ).rotateX(-Math.PI/2),
						new THREE.MeshBasicMaterial({color:0xffff00, wireframe:false})
					);
					renderer.domElement.addEventListener("mousemove", function(e) {
						camera.updateMatrixWorld(); // important!
						raycaster.setFromCamera( mouse, camera );
						var intersects = raycaster.intersectObject( ground );
						if ( !intersects.length ) return;
						intersecthelper.position.copy( intersects[0].point );
					});
					scene.add( intersecthelper );
				});

			})();


		</script>

		<script>

		//	TabUI

			(function(){

				var sidePanel = createSidePanel();
				var gameTab = TabUI.add( "Game", "game-tab" );
				var actionTab = TabUI.add( "Actions", "action-tab" );
				var animationTab = TabUI.add( "Animations", "animation-tab" );

			//	var loginTab = TabUI.add( "Login", "login-tab" );
			//	var debugTab = TabUI.add( "Debug", "debug-tab" );
			//	var weponTab = TabUI.add( "Wepon", "wepon-tab" );
			//	var levelTab = TabUI.add( "Levels", "level-tab" );
			//	var cameraTab = TabUI.add( "Camera", "camera-tab" );
			//	var playerTab = TabUI.add( "Players", "player-tab" );
			//	var controlTab = TabUI.add( "Controls", "control-tab" );
			//	var materialTab = TabUI.add( "Material", "material-tab" );
			//	var pathfinderTab = TabUI.add( "Pathfinder", "pathfinder-tab" );

				document.body.appendChild( sidePanel );
				TabUI.append( "Game", "Animations" );
				TabUI.Animations.role.classList.add("active");
				TabUI.Animations.tab.classList.add("in","active");

			})();

		</script>

		<script>

		//	Game tab.

			(function(){

			//	Players droplist.

				players = {}; // TODO: local.
				currentPlayer = "player1";

				var tab = TabUI.Game.tab;
				var row = document.createElement("h3");
				row.style.cssText = "padding-right:16px;";
				row.textContent = "Player:";

				var select = document.createElement("select");
				select.id = "players-droplist";
				select.style.cssText = "width:180px;color:#000;float:right;"
				+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
				+ "font-size:20px;margin-left:10px;";
				
				select.addEventListener( "change", function(){
					currentPlayer = this.value;
				});

				select.addPlayer = function( key, object, selected ){
					if ( !( key && object ) ) return;
					players[ key ] = object;
					var option = document.createElement("option");
					option.text = option.value = key;
					if ( selected ) {
						currentPlayer = option.value;
						option.setAttribute("selected", "");
					}
					select.appendChild( option );
				};

				select.getPlayer = function( key ){
					if ( key ) return players[ key ];
					return players[ this.value ];
				};

				select.getAnimationController = function( key ){
					if ( key ) return players[ key ].animationController;
					return players[ this.value ].animationController;
				};
				
				select.addMotion = function( name, clip ){
					for ( var key in players ) {
						if ( !( key && players[key] ) ) return;
						var animationController = this.getAnimationController( key );
						var mixer = animationController.mixer;
						var object = animationController.object;
						animationController.motion[ name ] = mixer.clipAction( clip, object );
					}
				};

				row.appendChild( select );
				tab.appendChild( row );

			})();

		</script>

		<script>

		//	Animation tab.

			(function(){

			//	Animation droplist.

				animations = []; // TODO: local.
				currentAnimation = "idling";

				var tab = TabUI.Animations.tab;
				var row = document.createElement("h3");
				row.style.cssText = "padding-right:0px;";
				row.textContent = "Animation:";

				var select = document.createElement("select");
				select.animations = {}; // important!
				select.id = "animation-droplist";
				select.style.cssText = "width:180px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;";

				(function(){
					var option = document.createElement("option");
					option.text = option.value = currentAnimation;
					select.appendChild( option );
				})();

				select.addEventListener( "change", function(){
					currentAnimation = this.value;
				});

				select.addAnimation = function( name, clip ){
					animations.push( clip );
					var option = document.createElement("option");
					option.text = option.value = name;
					this.appendChild( option );
				};

				select.getAnimations = function(){
					return animations;
				};

				row.appendChild( select );
				tab.appendChild( row );

			})();

		//	Lets load some animations.

			(function(){
				
				[
					"/manny/animations/sword/great sword slash.fbx",
					"/manny/animations/sword/great sword slash (2).fbx",
					"/manny/animations/sword/great sword slash (3).fbx",
					"/manny/animations/sword/great sword slash (4).fbx",
					"/manny/animations/sword/great sword slash (5).fbx",
					"/manny/animations/axe/standing melee combo attack ver. 3.fbx",
					"/manny/animations/axe/standing melee combo attack ver. 1.fbx",
					"/manny/animations/axe/standing melee combo attack ver. 2.fbx",

				].forEach(function( url ){
					var loader = new THREE.FBXLoader();
					loader.load( escape(url), function( group ){
						if ( !( group.animations && group.animations.length ) ) return;

						var clip = group.animations[0];

						clip.name = url.replace("/manny", "")
							.replace("/animations", "")
							.replace("/sword", "")
							.replace("/axe", "")
							.replace("/", "")
							.replace(".fbx", "");

						debugMode && console.log( clip.name+":", clip ); 

					//	document.getElementById("players-droplist").addMotion( clip.name, clip );
						document.getElementById("animation-droplist").addAnimation( clip.name, clip );

					},

					function(e){}, 
					function(err){
						console.error(err);
					});

				});

			})();

			(function(){

			//	Test Animation Button.

				var tab = TabUI.Animations.tab;
				var row = document.createElement("div");
				row.style.cssText = "margin:20px 12px 10px;height:35px;text-align:center;";

				var button1 = IdleButton();
				var button2 = TestButton();
				row.appendChild( button1 );
				row.appendChild( button2 );

				tab.appendChild( row );

				function IdleButton(){

					var button = document.createElement("div");
					button.id = "idle-animation";
					button.textContent = "Pause";
					button.title = "Pause animation action";
					button.style.cssText = "width:33%;float:left;height:40px;font-size:large;";
					button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );
					button.addEventListener( "click", function(){
						var select = document.getElementById("players-droplist");
						var animationController = select.getAnimationController( currentPlayer );
						if ( animationController.currentMotionName == "idling" ) return;
						animationController.play( "idling" ); 
					});

					return button;
				}

				function TestButton() {

					var button = document.createElement("div");
					button.id = "play-animation";
					button.textContent = "Play animation";
					button.title = "Test animation action";

					button.style.cssText = "width:65%;float:right;height:40px;font-size:large;";
					button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );
					button.addEventListener( "click", function(){
						var select = document.getElementById("players-droplist");
						var animationController = select.getAnimationController( currentPlayer );
						if ( animationController.currentMotionName == currentAnimation ) return;
						animationController.play( currentAnimation ); 
					});

					return button;
				}

			})();

			(function(){

			//	Add Action Button.

				var tab = TabUI.Animations.tab;
				var row = document.createElement("div");
				row.style.cssText = "margin:20px 12px 10px;height:35px;text-align:center;";
				row.appendChild( RemoveActionButton() );
				row.appendChild( AddActionButton() );
				tab.appendChild( row );

				function AddActionButton(){

					var button = document.createElement("div");
					button.id = "add-action";
					button.textContent = "Add Action";
					button.title = "Add action button";
					button.style.cssText = "width:49%;height:40px;float:right;font-size:large;";
					button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );
					button.addEventListener( "click", function(){

						if ( document.getElementById(currentAnimation) ) return;

						var actionButton = document.createElement("div");
						actionButton.id = currentAnimation;
						actionButton.title = currentAnimation;
						actionButton.classList.add("btn", "btn-white-outline", "btn-action");
						actionButton.style.cssText = "background-size:contain;"
						+ "background-image:url(/manny/animations/thumbs/"+currentAnimation+".png);";
						actionButton.addEventListener( "click", actionButtonClickHandler );
						function actionButtonClickHandler(){
							debugMode && console.log( actionButton.id );
						}

						document.getElementById("action-buttons").appendChild( actionButton );
					});

					return button;
				}

				function RemoveActionButton(){

					var button = document.createElement("div");
					button.id = "remove-action";
					button.textContent = "Remove";
					button.title = "Remove action button";
					button.style.cssText = "width:49%;height:40px;float:left;font-size:large;";
					button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );
					button.addEventListener( "click", function(){
						if ( !document.getElementById(currentAnimation) ) return;
						document.getElementById(currentAnimation).remove();
					});

					return button;
				}

			})();

			(function(){

			//	Import Animation Button.

				var tab = TabUI.Animations.tab;
				var row = document.createElement("div");
				row.style.cssText = "margin:20px 12px 10px;height:35px;text-align:center;";
				row.appendChild( ImportAnimationButton() );
				tab.appendChild( row );

				function ImportAnimationButton() {

					var button = document.createElement("div");
					button.id = "import-animaton";
					button.textContent = "Import animations";
					button.style.cssText = "width:100%;height:40px;font-size:large;";
					button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

					var input = document.createElement("input");
					input.type = "file";
					input.style.display = "none";
					input.setAttribute("multiple", "");

					var k = 0; // important!

					input.addEventListener( "change", function(){

						var select = document.getElementById("animation-droplist");
						if ( !select ) { input.value = ""; return; }

						for ( var i = 0; i < input.files.length; i++ ) {
							setTimeout(function( file ){

								var filename = file.name.replace(".fbx", "");
								var extension = file.name.split( "." ).pop().toLowerCase();

								var reader = new FileReader();

								reader.addEventListener( "progress", function ( e ) {
									var size = "(" + Math.floor( e.total / 1000 ).format() + " KB)";
									var progress = Math.floor( ( e.loaded / e.total ) * 100 ) + "%";
								//	console.log( "Loading", filename, size, progress );
								});

								reader.addEventListener( "load", function ( e ) {

									var data = reader.result;
									var loader = new THREE.FBXLoader();
									var group = loader.parse( data );

								//	Add animations.
								//	debugMode && console.log( group.animations );

									if ( group.animations && group.animations.length ) {

										group.animations.forEach( function( clip ){
											clip.name = filename;
											var name = ++k+"."+filename;

											document.getElementById("players-droplist").addMotion( name, clip );
											document.getElementById("animation-droplist").addAnimation( name, clip );

										});
									}

								}, false );
								reader.readAsArrayBuffer( file );

							}, 0, input.files[i] );
						}

					});

					button.addEventListener( "click", function(){
						
						input.value = "";
						input.click();

					});

					button.appendChild( input );
					return button;

				}

			})();

			setTimeout(function(){

			//	Action buttons container.

				var tab = TabUI.Animations.tab;
				var container = document.createElement("div");
				container.id = "action-buttons";
				container.style.cssText = "width:101%;max-height:300px;"
				+ "margin-top:20px;margin-bottom:20px;overflow-y:auto;";
				tab.appendChild( container );

			});

			setTimeout(function(){

			//	New game.

				P1 = {health:0}; 
				P2 = {health:0};

			//	Intersect bodies.

				var intersectHead = new THREE.Mesh(
					new THREE.SphereGeometry( 2, 6, 4 ),
					new THREE.MeshBasicMaterial({color:0xffff00,  wireframe:true})
				); 

				var intersectBody = new THREE.Mesh(
					new THREE.SphereGeometry( 4, 6, 4 ),
					new THREE.MeshBasicMaterial({color:0xffff00,  wireframe:true})
				); 

				//	at "/manny/js/three.js" (r96) we comment line 43269:
				//	"if ( object.visible === false ) return;" to accept invisible objects raycasting.
				intersectHead.visible = intersectBody.visible = true; // TODO: false.

				P1.intersectHead = intersectHead.clone();
				P1.intersectBody = intersectBody.clone();
				P2.intersectHead = intersectHead.clone();
				P2.intersectBody = intersectBody.clone();

				P1.intersectHead.name = "intersectHeadPlayer1";
				P1.intersectBody.name = "intersectBodyPlayer1";
				P2.intersectHead.name = "intersectHeadPlayer2";
				P2.intersectBody.name = "intersectBodyPlayer2";

			//	Attack helpers.

				var intersectLibs = new THREE.Mesh(
					new THREE.SphereGeometry( 0.5, 6, 4 ),
					new THREE.MeshLambertMaterial({color:0xff0000,  wireframe:false})
				); 

				P1.intersectLeftHand = intersectLibs.clone();
				P1.intersectLeftFoot = intersectLibs.clone();
				P1.intersectRightHand = intersectLibs.clone();
				P1.intersectRightFoot = intersectLibs.clone();

				P2.intersectLeftHand = intersectLibs.clone();
				P2.intersectLeftFoot = intersectLibs.clone();
				P2.intersectRightHand = intersectLibs.clone();
				P2.intersectRightFoot = intersectLibs.clone();

			//	Sword direction helper.

				var swordDirectionHelper = new THREE.Mesh(
					new THREE.SphereGeometry( 0.2, 6, 4 ),
					new THREE.MeshLambertMaterial({color:0xff0000,  wireframe:false})
				); 

			//	P1.swordDirection = swordDirectionHelper.clone();
			//	P1.swordDirection.position.set(7, 0.4, -1.9);
			//	scene.add( P1.swordDirection );

			});


			setTimeout(function(){

			//	Start Battle.
				
				var isFighting = false;
				var tab = TabUI.Animations.tab;
				var row = document.createElement("div");
				row.style.cssText = "margin:20px 12px 10px;height:35px;text-align:center;";

				var button = document.createElement("div");
				button.id = "start-raycasting";
				button.textContent = "Start Battle";
				button.style.cssText = "max-width:100%;width:100%;height:40px;font-size:large;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				button.addEventListener( "click", function(){
					button.value = !button.value;
				});

				watch( button, "value", function(prop, action, value){
					debugMode && console.log( "button value:",  value );

					if ( !value ) button.textContent = "Start Battle";
					else if ( value ) button.textContent = "Pause Battle";

					isFighting = value;

					startRaycasting();
					
				});

				function startRaycasting(){

					if ( !isFighting ) return;

					document.getElementById("player1-bar") && document.getElementById("player1-bar").remove();
					document.getElementById("player2-bar") && document.getElementById("player2-bar").remove();

					player1.lookAt(player2.position); // TODO: get player1 from players droplist (via uuid).
					player2.lookAt(player1.position); // TODO: get player2 from players droplist (via uuid).

					P1.health = 100; P2.health = 100; // important!

					setTimeout(function(){

					//	Health bar (player 1).
						
						if ( !isFighting ) {
							unwatch( P1, "health", P1.healthWacher );
							return;
						}
					//
						var bar = document.createElement("div");
						bar.id = "player1-bar";
						bar.title = "Player1 Health Bar";
						bar.style.cssText = "width:350px;height:40px;position:fixed;top:10px;left:10px;"
						+ "border:2px solid #fff;border-radius:8px;background-color:#f00;";

						var health_bar = document.createElement("div");
						health_bar.id = "player1-health-bar";
						health_bar.style.cssText = "width:100%;height:100%;border-radius:4px;"
						+ "background-color:#ff0;float:left;";
						bar.appendChild( health_bar );

						var text_bar = document.createElement("div");
						text_bar.style.cssText = "width:100%;text-align:center;background:none;"
						+ "position:absolute;font-weight:bold;color:#fff;font-size:x-large;";
						bar.appendChild( text_bar );

						document.body.appendChild( bar );
						text_bar.textContent = health_bar.style.width;

						P1.healthWacher = function(prop, action, value){
							health_bar.style.width = round( value, 1 ) + "%";
							text_bar.textContent = health_bar.style.width;
						};

						watch( P1, "health", P1.healthWacher );

					});

					setTimeout(function(){

					//	Health bar (player 2).
						
						if ( !isFighting ) {
							unwatch( P2, "health", P2.healthWacher );
							return;
						}
					//
						var bar = document.createElement("div");
						bar.id = "player2-bar";
						bar.title = "Player2 Health Bar";
						bar.style.cssText = "width:350px;height:40px;position:fixed;top:10px;right:380px;"
						+ "border:2px solid #fff;border-radius:8px;background-color:#f00;";

						var health_bar = document.createElement("div");
						health_bar.id = "player2-health-bar";
						health_bar.style.cssText = "width:100%;height:100%;border-radius:4px;"
						+ "background-color:#ff0;float:right;";
						bar.appendChild( health_bar );

						var text_bar = document.createElement("div");
						text_bar.style.cssText = "width:100%;text-align:center;background:none;"
						+ "position:absolute;font-weight:bold;color:#fff;font-size:x-large;";
						bar.appendChild( text_bar );

						document.body.appendChild( bar );
						text_bar.textContent = health_bar.style.width;

						P2.healthWacher = function(prop, action, value){
							health_bar.style.width = round( value, 1 ) + "%";
							text_bar.textContent = health_bar.style.width;
						};

						watch( P2, "health", P2.healthWacher );

					});

				//	Intersect bodies.

					setTimeout(function(){
						
						var requestAnimationFrameID;
						
						P1.headBone = player1.getObjectByName("Head");
						P1.bodyBone = player1.getObjectByName("Spine1");
						P1.leftfootBone = player1.getObjectByName("LeftToeBase");
						P1.rightfootBone = player1.getObjectByName("RightToeBase");
						P1.lefthandBone = player1.getObjectByName("LeftHandIndex1");
						P1.righthandBone = player1.getObjectByName("RightHandIndex1");

						P2.headBone = player2.getObjectByName("Head");
						P2.bodyBone = player2.getObjectByName("Spine1");
						P2.leftfootBone = player2.getObjectByName("LeftToeBase");
						P2.rightfootBone = player2.getObjectByName("RightToeBase");
						P2.lefthandBone = player2.getObjectByName("LeftHandIndex1");
						P2.righthandBone = player2.getObjectByName("RightHandIndex1");

						scene.add( P1.intersectHead, P1.intersectBody );
						scene.add( P1.intersectLeftFoot, P1.intersectRightFoot );
						scene.add( P1.intersectLeftHand, P1.intersectRightHand );

						scene.add( P2.intersectHead, P2.intersectBody );
						scene.add( P2.intersectLeftFoot, P2.intersectRightFoot );
						scene.add( P2.intersectLeftHand, P2.intersectRightHand );

						(function update(){
							requestAnimationFrameID = requestAnimationFrame( update );

							if ( !isFighting ) {
								cancelAnimationFrame( requestAnimationFrameID );

								scene.remove( P1.intersectHead, P1.intersectBody );
								scene.remove( P2.intersectHead, P2.intersectBody );

								scene.remove( P1.intersectLeftFoot, P1.intersectRightFoot );
								scene.remove( P1.intersectLeftHand, P1.intersectRightHand );
								scene.remove( P2.intersectLeftFoot, P2.intersectRightFoot );
								scene.remove( P2.intersectLeftHand, P2.intersectRightHand );

								return;
							}

						//	player1.updateMatrixWorld(); // (we update scene.updateMatrixWorld() in world update). important! 
							P1.intersectHead.position.setFromMatrixPosition(P1.headBone.matrixWorld);
							P1.intersectHead.rotation.setFromRotationMatrix(P1.headBone.matrixWorld);
							P1.intersectBody.position.setFromMatrixPosition(P1.bodyBone.matrixWorld);
							P1.intersectBody.rotation.setFromRotationMatrix(P1.bodyBone.matrixWorld);
						//	player2.updateMatrixWorld(); // (we update scene.updateMatrixWorld() in world update). important! 
							P2.intersectHead.position.setFromMatrixPosition(P2.headBone.matrixWorld);
							P2.intersectHead.rotation.setFromRotationMatrix(P2.headBone.matrixWorld);
							P2.intersectBody.position.setFromMatrixPosition(P2.bodyBone.matrixWorld);
							P2.intersectBody.rotation.setFromRotationMatrix(P2.bodyBone.matrixWorld);

						//	Libs helpers.
						//	player1.updateMatrixWorld(); // (we update scene.updateMatrixWorld() in world update). important! 
							P1.intersectLeftFoot.position.setFromMatrixPosition(P1.leftfootBone.matrixWorld);
							P1.intersectRightFoot.position.setFromMatrixPosition(P1.rightfootBone.matrixWorld);
							P1.intersectLeftHand.position.setFromMatrixPosition(P1.lefthandBone.matrixWorld);
							P1.intersectRightHand.position.setFromMatrixPosition(P1.righthandBone.matrixWorld);
						//	P1.intersectRightHand.rotation.setFromRotationMatrix(P1.righthandBone.matrixWorld);

						//	player2.updateMatrixWorld(); // (we update scene.updateMatrixWorld() in world update). important! 
							P2.intersectLeftFoot.position.setFromMatrixPosition(P2.leftfootBone.matrixWorld);
							P2.intersectRightFoot.position.setFromMatrixPosition(P2.rightfootBone.matrixWorld);
							P2.intersectLeftHand.position.setFromMatrixPosition(P2.lefthandBone.matrixWorld);
							P2.intersectRightHand.position.setFromMatrixPosition(P2.righthandBone.matrixWorld);

						})();

					});

					//	P1.LeftLeg = player1.getObjectByName("LeftLeg");
					//	P1.LeftHandIndex1 = player1.getObjectByName("LeftHandIndex1");
					//	P1.RightLeg = player1.getObjectByName("RightLeg");
					//	var legBone = player1.getObjectByName("RightLeg");
					//	P1.LegRaycaster = new THREE.Raycaster();

				//	Hand Raycaster (player 1).

					setTimeout(function(){

						var requestAnimationFrameID;

						var far = 8;
						var bone = P1.righthandBone; // player1.getObjectByName("RightHandIndex1");
						var origin = new THREE.Vector3(); // .setFromMatrixPosition(bone.matrixWorld);
						var direction = new THREE.Vector3(); // .setFromMatrixPosition(bone.matrixWorld);
						var intersectObjects = [P2.intersectHead, P2.intersectBody];

					//	raycaster helper.
						var arrowBone = player1.getObjectByName("RightHand");
						var originBone = player1.getObjectByName("RightHandRing1");
						var directionBone = player1.getObjectByName("RightHandIndex1");
						var arrow = new THREE.ArrowHelper( 
							new THREE.Vector3().setFromMatrixPosition(directionBone.matrixWorld), // direction.
							new THREE.Vector3().setFromMatrixPosition(originBone.matrixWorld), // origin.
							far, 0xffffff, 0.5 ); 
						scene.add( arrow );

						var raycaster = new THREE.Raycaster();
						raycaster.far = far;
						raycaster.ray.origin = origin.setFromMatrixPosition(bone.matrixWorld);
						raycaster.ray.direction.subVectors( direction, origin ).normalize(); // important! Must be normalize.

					//	ray helper.
						var material = new THREE.LineBasicMaterial({color:0x00ff00});
						var geometry = new THREE.Geometry();
						geometry.vertices.push( origin, direction );
						var line = new THREE.Line( geometry, material ); 
						scene.add( line );

						(function update(){
							requestAnimationFrameID = requestAnimationFrame( update );

							if ( !( P1.health > 0 && P2.health > 0 ) ) {
								cancelAnimationFrame( requestAnimationFrameID );
								(function(){
									players.player1.animationController.play("idling");
									player1.rotation.y = 0; player2.rotation.y = 0;
									scene.remove( line ); scene.remove( arrow ); 
									isFighting = false;
								})();
								return;
							} 
							
							if ( !isFighting ) {
								cancelAnimationFrame( requestAnimationFrameID );
								scene.remove( line ); scene.remove( arrow ); 
								return;
							}

							origin.copy( P1.intersectRightHand.position ); //.setFromMatrixPosition(bone.matrixWorld);
							direction.copy( P2.intersectHead.position ); //.setFromMatrixPosition(Spine.matrixWorld);
							raycaster.ray.direction.subVectors( direction, origin ).normalize(); // Must be normalize!
							
							line.geometry.verticesNeedUpdate = true; // important!

						//	arrow.setLength(raycaster.far);
							arrow.position.setFromMatrixPosition(arrowBone.matrixWorld);
							arrow.setDirection( new THREE.Vector3().subVectors( 
								new THREE.Vector3().setFromMatrixPosition(directionBone.matrixWorld), 
								new THREE.Vector3().setFromMatrixPosition(originBone.matrixWorld)
							));

						})();

					});

				//	Foot Raycaster (player 1).

					setTimeout(function(){

						var requestAnimationFrameID;

						var far = 1;
						var bone = P1.rightfootBone; // player1.getObjectByName("RightToeBase");
						var origin = new THREE.Vector3(); // .setFromMatrixPosition(bone.matrixWorld);
						var direction = new THREE.Vector3(); // .setFromMatrixPosition(bone.matrixWorld);
						var intersectObjects = [P2.intersectHead, P2.intersectBody];

						var raycaster = new THREE.Raycaster();
						raycaster.far = far;
						raycaster.ray.origin = origin.setFromMatrixPosition(bone.matrixWorld);
						raycaster.ray.direction.subVectors( direction, origin ).normalize(); // important! Must be normalize.

					//	ray helper.
						var material = new THREE.LineBasicMaterial({color:0x00ff00});
						var geometry = new THREE.Geometry();
						geometry.vertices.push( origin, direction );
						var line = new THREE.Line( geometry, material ); 
						scene.add( line );

					//	raycaster helper.
					//	var arrow = new THREE.ArrowHelper( direction, origin, far, 0xffffff, 0.5 );
					//	arrow.setLength(raycaster.far);
					//	arrow.setDirection(raycaster.ray.direction);
					//	scene.add( arrow );

						(function update(){
							requestAnimationFrameID = requestAnimationFrame( update );

							if ( !( P1.health > 0 && P2.health > 0 ) ) {
								cancelAnimationFrame( requestAnimationFrameID );
								(function(){
									players.player1.animationController.play("idling");
									player1.rotation.y = 0; player2.rotation.y = 0;
									scene.remove( line ); // scene.remove( arrow ); 
									isFighting = false;
								})();
								return;
							} 
							
							if ( !isFighting ) {
								cancelAnimationFrame( requestAnimationFrameID );
								scene.remove( line ); // scene.remove( arrow ); 
								return;
							}

							origin.copy( P1.intersectRightFoot.position ); //.setFromMatrixPosition(bone.matrixWorld);
							direction.copy( P2.intersectBody.position ); //.setFromMatrixPosition(Spine.matrixWorld);
							line.geometry.verticesNeedUpdate = true; // important!

						//	raycaster.ray.origin = origin;
							raycaster.ray.direction.subVectors( direction, origin ).normalize(); // important! Must be normalize.

						//	arrow.setLength(raycaster.far);
						//	arrow.position.copy( raycaster.ray.origin );
						//	arrow.setDirection( raycaster.ray.direction );

						})();

					});

				}

				row.appendChild( button );
				tab.appendChild( row );

			});

		</script>

		<script>

		//	Load Player 1.

			(function(){

				var loader = new THREE.FBXLoader();
				loader.load( "/manny/characters/MannySwordIdle05.fbx", function( player ){

				//	player is a THREE.Group.
					player.name = "player1";
					var s = 0.00033; player.scale.set(s,s,s); // important!
					player.position.x = -10;
					scene.add( player );

					debugMode && console.log( player ); 

					var bones = {}; 	// create bone options. TODO!
					var meshes = {};	// create mesh options. TODO!
					var wepons = {};	// create wepon options. TODO!
					var skinned = {};	// create skinned options. TODO!
					var armature; 		// THREE.Group.
					var animationController;
					var animations = player.animations;
					var swordDirection = new THREE.Vector3(-0.12, 0.27, 1); // normalized!


					player.traverse( function( child ){

						if (child.name == "Armature") { 
							armature = child; 
						}

						if (child.isMesh) {	
							child.castShadow = true;	
							child.receiveShadow = true;	
							meshes[ child.name ] = child;
						}

						if ( child.isBone ) {
							bones[ child.name ] = child;
						}

						if ( child.isSkinnedMesh ) {
							skinned[ child.uuid ] = child;
						}

						if (child.name == "sword") {
							sword1 = child; // debug!
							wepons[ child.name ] = child;
						}

						if (child.name == "MannyTheSkeleton_v51") {
							(function(mesh){

							//	replace material.
								mesh.material = new THREE.MeshStandardMaterial({
									name:"Player1 Material", skinning:true, // important!
								});

								var loader = new THREE.ImageLoader();
								loader.setCrossOrigin("anonymous"); // important!
								var src = "https://i.imgur.com/rxUXS8C.png";
								loader.load( src, function( image ){
									var mapping = THREE.SphericalReflectionMapping;		// important!
									var texture = new THREE.Texture( image, mapping );	// important!
									mesh.material.roughness = 0; 
									mesh.material.metalness = 1; 
									mesh.material.envMap = texture; 
									mesh.material.envMap.needsUpdate = true; 
									mesh.material.needsUpdate = true;
								});

								debugMode && console.log( mesh.material ); 

							})( child );
						}

					});

					debugMode && console.log({
						"armature":armature,"bones":bones,"meshes":meshes,
						"wepons":wepons,"skinned":skinned,"animations":animations
					});

				//	Animation controller.

					if ( animations && animations.length ) {
					//	characters contains only idle animation.
						player.animations[0].name = "idling";
					}

					//	create animation controller.
					var animationController = new MW.AnimationController( player );

					//	bind animations.
					document.getElementById("animation-droplist").getAnimations().forEach(function( clip ){
						var mixer = animationController.mixer; var object = animationController.object;
						animationController.motion[ clip.name ] = mixer.clipAction( clip, object );
					});

					//	Animation controller update.
					var clock = new THREE.Clock();

					(function update(){
						requestAnimationFrame( update );
						var delta = clock.getDelta();
						animationController.update( delta );
					})();

					//	Play idling animation.
					if ( animationController.motion.idling ) {
					//	animationController.play("idling");
					}

				//	Players droplist.

					(function( select ){
						if ( !select ) return;
						var object = {
							name: player.name,
							uuid: player.uuid, // THREE.Math.generateUUID(),
						};
						if ( animationController ) {
							object.animationController = animationController;
						}
						select.addPlayer( player.name, object, true);
					})( document.getElementById("players-droplist") );

					player1 = player; // debug!

				},

				function(e){}, 
				function(err){
					console.error(err);
				});

			})();

		</script>


		<script>

		//	Load Player 2.

			(function(){

				var loader = new THREE.FBXLoader();
				loader.load( "/manny/characters/MannySwordIdle04.fbx", function( player ){

				//	player is a THREE.Group.
					player.name = "player2";
					var s = 0.00033; player.scale.set(s,s,s); // important!
					player.position.x = 10;
					scene.add( player );

					debugMode && console.log( player ); 

					var bones = {}; 	// create bone options. TODO!
					var meshes = {};	// create mesh options. TODO!
					var wepons = {};	// create wepon options. TODO!
					var skinned = {};	// create skinned options. TODO!
					var armature; 		// THREE.Group.
					var animationController;
					var animations = player.animations;

					player.traverse( function( child ){

						if (child.name == "Armature") { 
							armature = child; 
						}

						if (child.isMesh) {	
							child.castShadow = true;	
							child.receiveShadow = true;	
							meshes[ child.name ] = child;
						}

						if ( child.isBone ) {
							bones[ child.name ] = child;
						}

						if ( child.isSkinnedMesh ) {
							skinned[ child.uuid ] = child;
						}

						if (child.name == "sword") {
							sword2 = child; // debug!
							wepons[ child.name ] = child;
						}

						if (child.name == "MannyTheSkeleton_v51") {
							(function(mesh){

							//	replace material.
								mesh.material = new THREE.MeshStandardMaterial({
									name:"Player2 Material", skinning:true, // important!
								});

								var loader = new THREE.ImageLoader();
								loader.setCrossOrigin("anonymous"); // important!
								var src = "https://i.imgur.com/Fx9154f.png";
								loader.load( src, function( image ){
									var mapping = THREE.SphericalReflectionMapping;		// important!
									var texture = new THREE.Texture( image, mapping );	// important!
									mesh.material.roughness = 0; 
									mesh.material.metalness = 1; 
									mesh.material.envMap = texture; 
									mesh.material.envMap.needsUpdate = true; 
									mesh.material.needsUpdate = true;
								});

								debugMode && console.log( mesh.material ); 

							})( child );
						}

					});

					debugMode && console.log({
						"armature":armature,"bones":bones,"meshes":meshes,
						"wepons":wepons,"skinned":skinned,"animations":animations
					});

				//	Animation controller.

					if ( animations && animations.length ) {
					//	characters contains only idle animation.
						player.animations[0].name = "idling";
					}

					//	create animation controller. (always)
					var animationController = new MW.AnimationController( player );

					//	bind animations.
					document.getElementById("animation-droplist").getAnimations().forEach(function( clip ){
						var mixer = animationController.mixer; var object = animationController.object;
						animationController.motion[ clip.name ] = mixer.clipAction( clip, object );
					});

					//	Animation controller update.
					var clock = new THREE.Clock();

					(function update(){
						requestAnimationFrame( update );
						var delta = clock.getDelta();
						animationController.update( delta );
					})();

					//	Play idling animation.
					if ( animationController.motion.idling ) {
						animationController.play("idling");
					}

				//	Players droplist.

					(function( select ){
						if ( !select ) return;
						var object = {
							name: player.name,
							uuid: player.uuid, // THREE.Math.generateUUID(),
						};
						if ( animationController ) {
							object.animationController = animationController;
						}
						select.addPlayer( player.name, object);
					})( document.getElementById("players-droplist") );

					player2 = player; // debug!

				},

				function(e){}, 
				function(err){
					console.error(err);
				});

			})();

		</script>

		<script>
/*
				//	Player intersect body.

					setTimeout(function(){

						var bone = player.getObjectByName("Spine1");
						var intersectBody = new THREE.Mesh(
							new THREE.SphereGeometry( 4, 6, 4 ),
							new THREE.MeshBasicMaterial({color:0xffff00,  wireframe:true})
						); 

						intersectBody.name = "intersectBodyPlayer1";
						scene.add( intersectBody ); // important!

					//	at "/manny/js/three.js" (r96) we comment 
					//	line 43269: "if ( object.visible === false ) return;"
					//	to accept invisible objects raycasting.
						intersectBody.visible = false;

						(function update(){
							requestAnimationFrame( update );
						//	scene.updateMatrixWorld(); // important! (we do in world update).
							intersectBody.position.setFromMatrixPosition(bone.matrixWorld);
							intersectBody.rotation.setFromRotationMatrix(bone.matrixWorld);
						})();
					});

				//	Player intersect head.

					setTimeout(function(){

						var bone = player.getObjectByName("Head");
						var intersectHead = new THREE.Mesh(
							new THREE.SphereGeometry( 2, 6, 4 ),
							new THREE.MeshBasicMaterial({color:0xffff00,  wireframe:true})
						); 

						intersectHead.name = "intersectHeadPlayer1";
						scene.add( intersectHead ); // important!

					//	at "/manny/js/three.js" (r96) we comment 
					//	line 43269: "if ( object.visible === false ) return;"
					//	to accept invisible objects raycasting.
						intersectHead.visible = false;

						(function update(){
							requestAnimationFrame( update );
						//	scene.updateMatrixWorld(); // important! (we do in world update).
							intersectHead.position.setFromMatrixPosition(bone.matrixWorld);
							intersectHead.rotation.setFromRotationMatrix(bone.matrixWorld);
						})();
					});
*/
/*
				//	Player intersect body.

					setTimeout(function(){

						var bone = player.getObjectByName("Spine1");
						var intersectBody = new THREE.Mesh(
							new THREE.SphereGeometry( 4, 6, 4 ),
							new THREE.MeshBasicMaterial({color:0xffff00,  wireframe:true})
						); 

						intersectBody.name = "intersectBodyPlayer2";
						scene.add( intersectBody ); // important!

					//	at "/manny/js/three.js" (r96) we comment 
					//	line 43269: "if ( object.visible === false ) return;"
					//	to accept invisible objects raycasting.
						intersectBody.visible = false;

						(function update(){
							requestAnimationFrame( update );
						//	scene.updateMatrixWorld(); // important! (we do in world update).
							intersectBody.position.setFromMatrixPosition(bone.matrixWorld);
							intersectBody.rotation.setFromRotationMatrix(bone.matrixWorld);
						})();
					});

				//	Player intersect head.

					setTimeout(function(){

						var bone = player.getObjectByName("Head");
						var intersectHead = new THREE.Mesh(
							new THREE.SphereGeometry( 2, 6, 4 ),
							new THREE.MeshBasicMaterial({color:0xffff00,  wireframe:true})
						); 

						intersectHead.name = "intersectHeadPlayer2";
						scene.add( intersectHead ); // important!

					//	at "/manny/js/three.js" (r96) we comment 
					//	line 43269: "if ( object.visible === false ) return;"
					//	to accept invisible objects raycasting.
						intersectHead.visible = false;

						(function update(){
							requestAnimationFrame( update );
						//	scene.updateMatrixWorld(); // important! (we do in world update).
							intersectHead.position.setFromMatrixPosition(bone.matrixWorld);
							intersectHead.rotation.setFromRotationMatrix(bone.matrixWorld);
						})();
					});
*/

		</script>

	</body>
</html>
